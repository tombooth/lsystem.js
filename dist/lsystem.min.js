/*! lsystem 06-05-2013 */
(function(){window.L={turtle:{}}})(),function(t){function i(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}function n(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]}t.math={},t.math.degToRad=function(t){return t*(Math.PI/180)},t.math.rotationMatrixUp=function(t){return[[Math.cos(t),-Math.sin(t),0],[Math.sin(t),Math.cos(t),0],[0,0,1]]},t.math.rotationMatrixLeft=function(t){return[[Math.cos(t),0,Math.sin(t)],[0,1,0],[-Math.sin(t),0,Math.cos(t)]]},t.math.rotationMatrixHeading=function(t){return[[1,0,0],[0,Math.cos(t),Math.sin(t)],[0,-Math.sin(t),Math.cos(t)]]},t.math.matrixMult=function(t,i){var n=[[0,0,0],[0,0,0],[0,0,0]];return n[0][0]=t[0][0]*i[0][0]+t[1][0]*i[0][1]+t[2][0]*i[0][2],n[0][1]=t[0][1]*i[0][0]+t[1][1]*i[0][1]+t[2][1]*i[0][2],n[0][2]=t[0][2]*i[0][0]+t[1][2]*i[0][1]+t[2][2]*i[0][2],n[1][0]=t[0][0]*i[1][0]+t[1][0]*i[1][1]+t[2][0]*i[1][2],n[1][1]=t[0][1]*i[1][0]+t[1][1]*i[1][1]+t[2][1]*i[1][2],n[1][2]=t[0][2]*i[1][0]+t[1][2]*i[1][1]+t[2][2]*i[1][2],n[2][0]=t[0][0]*i[2][0]+t[1][0]*i[2][1]+t[2][0]*i[2][2],n[2][1]=t[0][1]*i[2][0]+t[1][1]*i[2][1]+t[2][1]*i[2][2],n[2][2]=t[0][2]*i[2][0]+t[1][2]*i[2][1]+t[2][2]*i[2][2],n},t.math.absCrossProduct=function(t,s){var e=i(t),o=i(s),h=Math.acos(n(t,s)/(e*o));return e*o*Math.sin(h)}}(L),function(t){function i(){}i.prototype.step=function(t,i,n,s){var e,o,h,r,a;return e=t.charAt(i),(o=this.fns[e])&&("("!==t.charAt(i+1)?o.call(n,s):(h=t.indexOf(")",i),r=t.substring(i+2,h),a=r.split(","),a.push(s),o.apply(n,a),i=h)),i},t.Turtle=i}(L),function(t){t.turtle.fns={},t.turtle.fns.F=function(i,n){if(n||(n=i,i=this.defaultDistance),n.beginPath(),n.lineWidth=this.lineWidth,n.moveTo(this.position[0],this.position[1]),this.position[0]=this.position[0]+i*this.heading[0],this.position[1]=this.position[1]+i*this.heading[1],this.position[2]=this.position[2]+i*this.heading[2],n.lineTo(this.position[0],this.position[1]),n.stroke(),this.tropismEnabled){var s=this.tropismConstant*t.math.absCrossProduct(this.heading,this.tropism),e=t.math.matrixMult([this.heading,this.left,this.up],t.math.rotationMatrixLeft(s));this.heading=e[0],this.left=e[1],this.up=e[2]}},t.turtle.fns.f=function(t,i){i||(i=t,t=this.defaultDistance),this.position[0]=this.position[0]+t*this.heading[0],this.position[1]=this.position[1]+t*this.heading[1],this.position[2]=this.position[2]+t*this.heading[2]},t.turtle.fns["+"]=function(i,n){n||(n=i,i=this.defaultAngle);var s=t.math.matrixMult([this.heading,this.left,this.up],t.math.rotationMatrixUp(t.math.degToRad(i)));this.heading=s[0],this.left=s[1],this.up=s[2]},t.turtle.fns["-"]=function(i,n){n||(n=i,i=this.defaultAngle),t.turtle.fns["+"].call(this,-i,n)},t.turtle.fns["&"]=function(i){var n=t.math.matrixMult([this.heading,this.left,this.up],t.math.rotationMatrixLeft(t.math.degToRad(i)));this.heading=n[0],this.left=n[1],this.up=n[2]},t.turtle.fns["/"]=function(i){var n=t.math.matrixMult([this.heading,this.left,this.up],t.math.rotationMatrixHeading(t.math.degToRad(i)));this.heading=n[0],this.left=n[1],this.up=n[2]},t.turtle.fns["!"]=function(t){this.lineWidth=t},t.turtle.fns["["]=function(){this.pushState()},t.turtle.fns["]"]=function(){this.popState()}}(L),function(t){function i(t,i){this.initialState=t,this.fns=i}i.prototype=new t.Turtle,i.prototype.render=function(t,i,n){var s=this._buildTree(t);s.state=this.initialState.duplicate(),this._renderTree(s,i,n)},i.prototype._buildTree=function(t){var i,n,s;s={children:[],instructions:""};for(var e=0;t.length>e;e++)if(i=t.charAt(e),"["===i)n=this._buildTree(t.substr(e+1)),s.instructions+="#"+(s.children.push(n)-1),e+=n.endIndex+1;else{if("]"===i)break;s.instructions+=i}return s.endIndex=e,s},i.prototype._renderTree=function(t,i){var n,s,e,o,h,r,a,u="";r=t.instructions,a=t.state;for(var p=0;r.length>p;p++)if(n=r.charAt(p),s=this.fns[n])if(1===s.length)s.call(a,i);else{if(e=r.indexOf(")",p),o=r.substring(p+2,e),h=o.split(","),h.push(i),h.length!=s.length)throw Error("Could not extract the correct number of parameters for "+n);u+=s.apply(a,h),p=e}else"#"===n&&(t.children[+r.charAt(++p)].state=a.duplicate());for(p=0;t.children.length>p;p++)setTimeout(this._renderTree.bind(this,t.children[p],i),50)},t.Turtle.Organic=i}(L),function(t){function i(t,i){this.initialState=t,this.fns=i}i.prototype=new t.Turtle,i.prototype.render=function(t,i,n){this._renderRecurse(t,this.initialState.duplicate(),i,n)},i.prototype._renderRecurse=function(t,i,n,s){var e;t.length>0?(e=this.step(t,0,i,n),setTimeout(this._renderRecurse.bind(this,t.substring(0===e?1:e),i,n,s),0)):s&&s()},t.Turtle.Recursive=i}(L),function(t){function i(t,i){this.initialState=t,this.fns=i}i.prototype=new t.Turtle,i.prototype.render=function(t,i,n){for(var s=this.initialState.duplicate(),e=0;t.length>e;e++)e=this.step(t,e,s,i);n&&n()},t.Turtle.Simple=i}(L),function(t){function i(t){this.stack=[],this.fromObject(t)}i.prototype.withLineWidth=function(t){return this.lineWidth=t,this},i.prototype.withDefaultDistance=function(t){return this.defaultDistance=t,this},i.prototype.withPosition=function(t,i,n){return this.position=[t,i,n],this},i.prototype.withTropismEnabled=function(t){return this.tropismEnabled=t,this},i.prototype.withTropismVector=function(t,i,n){return this.tropism=[t,i,n],this},i.prototype.withTropismConstant=function(t){return this.tropismConstant=t,this},i.prototype.pushState=function(){this.stack.push(this.toObject())},i.prototype.popState=function(){this.fromObject(this.stack.pop())},i.prototype.duplicate=function(){return new i(this.toObject())},i.prototype.fromObject=function(t){this.lineWidth=t&&t.lineWidth||1,this.defaultDistance=t&&t.defaultDistance||10,this.defaultAngle=t&&t.defaultAngle||90,this.position=t&&t.position||[0,0,0],this.heading=t&&t.heading||[0,-1,0],this.left=t&&t.left||[-1,0,0],this.up=t&&t.up||[0,0,-1],this.tropismEnabled=t&&void 0!==t.tropismEnabled?!!t.tropismEnabled:!1,this.tropism=t&&t.tropism||[0,0,0],this.tropismConstant=t&&t.tropismConstant||1},i.prototype.toObject=function(){return{lineWidth:this.lineWidth,defaultDistance:this.defaultDistance,defaultAngle:this.defaultAngle,position:[this.position[0],this.position[1],this.position[2]],heading:[this.heading[0],this.heading[1],this.heading[2]],left:[this.left[0],this.left[1],this.left[2]],up:[this.up[0],this.up[1],this.up[2]],tropismEnabled:this.tropismEnabled,tropism:this.tropism&&[this.tropism[0],this.tropism[1],this.tropism[2]],tropismConstant:this.tropismConstant}},t.Turtle.State=i}(L),function(t){function i(t,i,n){"object"==typeof t?(this.axiom=t.axiom,this.constants=t.constants,this.rules=t.rules):(this.axiom=t,this.constants=i,this.rules=n)}i.prototype.iterate=function(t,i,n){var s,e,o,h,r,a,u="";if(n=n||this.axiom,0===t)return i(n),void 0;for(var p=0;n.length>p;p++)if(s=n.charAt(p),e=this.rules[s]){if(a=typeof e,"string"===a)u+=e;else if("function"===a)if(0===e.length)u+=e.call(this.constants);else{if(o=n.indexOf(")",p),h=n.substring(p+2,o),r=h.split(","),r.length!=e.length)throw Error("Could not extract the correct number of parameters for "+s);u+=e.apply(this.constants,r),p=o}}else u+=s;setTimeout(this.iterate.bind(this,t-1,i,u),0)},t.System=i}(L),function(t){t.examples={tree:{name:"Tree",system:new t.System({axiom:"!(1)F(130)/(45)A",constants:{d1:94.74,d2:132.63,a:18.95,lr:1.009,vr:1.532},rules:{A:function(){return"!("+this.vr+")F(30)[&("+this.a+")F(30)A]/("+this.d1+")"+"[&("+this.a+")F(30)A]/("+this.d2+")[&("+this.a+")F(30)A]"},F:function(t){return"F("+t*this.lr+")"},"!":function(t){return"!("+t*this.vr+")"}}}),state:(new t.Turtle.State).withLineWidth(1.732).withTropismEnabled(!0).withTropismVector(0,-1,0).withTropismConstant(.25),iterations:7},quadratic_snowflake:{name:"Quadratic Snowflake",system:new t.System({axiom:"-F",rules:{F:"F+F-F-F+F"}}),state:(new t.Turtle.State).withDefaultDistance(5),iterations:4}}}(L);